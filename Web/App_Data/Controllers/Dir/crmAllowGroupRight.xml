<?xml version="1.0" encoding="utf-8"?>

<dir table="crmquyennsd" code="ma_dvcs, ma_quyen, user_id" order="ma_dvcs, ma_quyen, user_id" database="Sys" xmlns="urn:schemas-Sthink-company:data-dir">
  <title v="quyền nhóm người sử dụng" e="Group Access Control"></title>

  <fields>
	  <field name="ma_dvcs" isPrimaryKey="true" hidden="true" readOnly="true">
		  <header v="" e=""></header>
	  </field>
    <field name="user_id" isPrimaryKey="true" type="Decimal" disabled="true" hidden="true">
      <header v="" e=""></header>
      <items style="Numeric"></items>
    </field>
    <field name="ma_quyen" isPrimaryKey="true" clientDefault="Default" allowNulls="false">
      <header v="Quyền sử dụng" e="Access Right"></header>
      <items style="AutoComplete" controller="crmAccessRight" reference="ten_quyen%l" key="status = '1'" check="1 = 1" information="ma_quyen$crmdmquyen.ten_quyen%l" row="1"/>
      <clientScript><![CDATA[onchange=onChange$UserRightForm$RightID(this);]]></clientScript>
    </field>
    <field name="ten_quyen%l" readOnly="true" external="true" defaultValue="''"  clientDefault="Default">
      <header v="" e=""></header>
    </field>
    <field name="name" dataFormatString="X" allowNulls="false" external="true" defaultValue="''">
      <header v="Nhóm" e="Group"></header>
      <items style="AutoComplete" controller="UserGroup" reference="comment%l" key="user_yn = 0 and status = '1' and exists(select 1 from @@appDatabaseName..sysunitrights r where r.user_id = @@userID and r.ma_dvcs = @@unit and r.r_access=1)" check="user_yn = 0 and exists(select 1 from @@appDatabaseName..sysunitrights r where r.user_id = @@userID and r.ma_dvcs = @@unit and r.r_access=1)" information="name$userinfo2.comment%l"/>
      <clientScript><![CDATA[onchange=onChange$UserRightForm$GroupID(this);]]></clientScript>
    </field>
    <field name="comment%l" readOnly="true" external="true" defaultValue="''">
      <header v="" e=""></header>
    </field>
  </fields>

  <views>
    <view id="Dir" height="132">
      <item value="120, 100, 100, 230, 0"/>
      <item value="11101: [ma_quyen].Label, [ma_quyen], [ten_quyen%l], [ma_dvcs]"/>
      <item value="11101: [name].Label, [name], [comment%l], [user_id]"/>
    </view>
  </views>

  <commands>
    <command event="Loading">
      <text>
        <![CDATA[
declare @n varchar(32), @m nvarchar(128)
select @n = '', @m = ''
if @@action = 'Edit' begin
  select @n = rtrim(name), @m = case @@language when 'v' then rtrim(comment) else rtrim(comment2) end from userinfo2 where id = @user_id
end
select 'this._name = ''' + @n + ''';this._comment = ''' + replace(replace(@m, '\', '\\'), '''', '\''') + ''';active$UserRightForm$(this)' as message
return
]]>
      </text>
    </command>

    <command event="Closing">
      <text>
        <![CDATA[
select 'close$UserRightForm$(this)' as message
return
]]>
      </text>
    </command>

    <command event="Declare">
      <text>
        <![CDATA[
declare @$rightConflict nvarchar(512)
select @$rightConflict = case when @@language = 'v' then N'Mã quyền không hợp lệ.' else N'Invalid Access Right.' end
]]>
      </text>
    </command>

    <command event="Inserting">
      <text>
        <![CDATA[
if @@admin <> 1 return
if exists(select 1 from @@table where user_id = @user_id and ma_dvcs = @@unit and ma_quyen in (select ma_quyen from crmdmquyen where ma_dvcs = @@unit and loai_quyen in
  (select loai_quyen from crmdmquyen where ma_quyen = @ma_quyen and ma_dvcs = @@unit ))) begin
    select 'ma_quyen' as field, @$rightConflict as message
    return
  end
select @ma_dvcs = @@unit, @datetime0 = getdate(), @datetime2 = getdate(), @user_id0 = @@userID, @user_id2 = @@userID
]]>
      </text>
    </command>

    <command event="Inserted">
      <text>
        <![CDATA[
declare @t char(1), @userList varchar(8000), @userName varchar(32), @userID int
select @t = loai_quyen from crmdmquyen where ma_quyen = @ma_quyen and ma_dvcs = @@unit
select @userList = rtrim(user_lst) from userinfo2 where id = rtrim(@user_id)
if isnull(@userList , '') <> '' begin
  set @userList = @userList + ','
  while @userList <> '' begin
    set @userName = substring(rtrim(@userList), 0, charindex(',', @userList))
    set @userList = replace(@userList, @userName + ',', '')
    if @userName <> '' begin
      select @userID = id from userinfo2 where name = rtrim(ltrim(@userName))
      exec Sthink$CRM$System$SetAccessRight @userID, @@appDatabaseName, @t, @ma_dvcs
    end    
  end
end
]]>
      </text>
    </command>

    <command event="Updating">
      <text>
        <![CDATA[
if @@admin <> 1 return
declare @t1 char(1), @t2 char(2), @userList varchar(8000), @userName varchar(32), @userID int
select @t1 = loai_quyen from crmdmquyen where ma_quyen = $ma_quyen.OldValue and ma_dvcs = $ma_dvcs.OldValue
select @t2 = loai_quyen from crmdmquyen where ma_quyen = @ma_quyen and ma_dvcs = @ma_dvcs
if @t1 <> @t2
  begin
    if exists(select 1 from @@table where user_id = @user_id and ma_dvcs = @ma_dvcs and ma_quyen in (select ma_quyen from crmdmquyen where loai_quyen = @t2 and ma_dvcs = @ma_dvcs))
      begin
        select 'ma_quyen' as field, @$rightConflict as message
        return
    end
  end
]]>
      </text>
    </command>

    <command event="Updated">
      <text>
        <![CDATA[
select @userList = rtrim(user_lst) from userinfo2 where id = rtrim(@user_id)
if isnull(@userList, '') <> '' begin
  set @userList = @userList + ','
  while @userList <> '' begin
    set @userName = substring(rtrim(@userList), 0, charindex(',', @userList))
    set @userList = replace(@userList, @userName + ',', '')
    if @userName <> '' begin
      select @userID = id from userinfo2 where name = rtrim(ltrim(@userName))
      if @t1 <> @t2 begin
        exec dbo.Sthink$CRM$System$SetAccessRight @userID, @@appDatabaseName, @t1, @ma_dvcs
        exec dbo.Sthink$CRM$System$SetAccessRight @userID, @@appDatabaseName, @t2, @ma_dvcs
      end else exec dbo.Sthink$CRM$System$SetAccessRight @userID, @@appDatabaseName, @t2, @ma_dvcs
    end
  end
end
update @@table set datetime2 = getdate(), user_id2 = @@userID where user_id = @user_id and ma_quyen = @ma_quyen and ma_dvcs = @ma_dvcs
]]>
      </text>
    </command>

    <command event="Deleting">
      <text>
        <![CDATA[
if @@admin <> 1 return
]]>
      </text>
    </command>

    <command event="Deleted">
      <text>
        <![CDATA[
declare @t char(1), @userList varchar(8000), @userName varchar(32), @userID int
select @t = loai_quyen from crmdmquyen where ma_quyen = @ma_quyen
select @userList = rtrim(user_lst) from userinfo2 where id = rtrim(@user_id)
if isnull(@userList, '') <> '' begin
  set @userList = @userList + ','
  while @userList <> '' begin
    set @userName = substring(rtrim(@userList), 0, charindex(',', @userList))
    set @userList = replace(@userList, @userName + ',', '')
    if @userName <> '' begin
      select @userID = id from userinfo2 where name = rtrim(ltrim(@userName))
      exec Sthink$CRM$System$SetAccessRight @userID, @@appDatabaseName, @t, @ma_dvcs
    end
  end
end
]]>
      </text>
    </command>
  </commands>

  <script>
    <text>
      <![CDATA[
function active$UserRightForm$(f) {
  f.add_onResponseComplete(on$UserRightForm$ResponseComplete);
  if (f._action == 'Edit') {
    var o = f.getItem('name');
    f.setItemControlBehavior('name', f._name, f._comment, true);
    o.disabled = true;
    $common.setVisible(o.a, false);
  }
} 
function close$UserRightForm$(f) {try {f.remove_onResponseComplete(on$UserRightForm$ResponseComplete);} catch (ex) {}}
function onChange$UserRightForm$RightID(o) {
  var f = o.parentForm;
  if (f._action != 'Edit') f.setReferenceKeyFilter('name');
}
function onChange$UserRightForm$GroupID(o) {o.parentForm.request('GroupID', 'GroupID', ['name']);}
function on$UserRightForm$ResponseComplete(sender, e) {
  var f = e.object, context = e.type.Context, result = e.type.Result;
  switch (context) {
    case 'GroupID':
      f.setItemValue('user_id', result[0].Value);
      break;
    default:
      break;
  }
}
]]>
    </text>
  </script>

  <response>
    <action id="GroupID">
      <text>
        <![CDATA[
if exists(select 1 from @@sysDatabaseName..userinfo2 where name = @name) begin
  select id from @@sysDatabaseName..userinfo2 where name = @name
  return
end
]]>
      </text>
    </action>
  </response>
</dir>