<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE grid [
  <!ENTITY CommandWhenVoucherBeforeInit SYSTEM "..\Include\Command\WhenVoucherBeforeInit.txt">
  <!ENTITY CommandWhenVoucherBeforeAddNew SYSTEM "..\Include\Command\WhenVoucherBeforeAddNew.txt">
  <!ENTITY CommandWhenVoucherAfterInit SYSTEM "..\Include\Command\WhenVoucherAfterInit.txt">
  <!ENTITY XMLStandardVoucherToolbar SYSTEM "..\Include\XML\ExternalVoucherToolbar.xml">
  <!ENTITY DowloadScript SYSTEM "..\Include\Javascript\DownloadScript.txt">
  <!ENTITY Youtube SYSTEM "..\Include\Command\youtube.txt">
  <!ENTITY TransferID "PVTran">
  <!ENTITY CreateTicket "declare @ticket varchar(32), @filename varchar(128), @description nvarchar(128)
select @ticket = lower(replace(newid(),'-',''))
if @@language = 'v' select @filename = 'PVMaster.xlsx', @description = N'Hóa đơn mua hàng trong nước'
else select @filename = 'PVMaster2.xlsx', @description = N'Sales Invoice'
insert into @@sysDatabaseName..ticket values(@ticket, @@userID, '&TransferID;', @filename, @description, '@@appDatabaseName', getdate());">
]>

<grid table="m71$000000" code="stt_rec" order="ngay_ct desc, so_ct desc" type="Voucher" id="PNA" uniKey="true" xmlns="urn:schemas-Sthink-company:data-grid">
  <title v="Hóa đơn mua hàng trong nước" e="Domestic Purchase Invoice"></title>
  <subTitle v="Cập nhật hóa đơn: thêm, sửa, xóa..." e="New, Edit, Delete Invoice..."></subTitle>
  <partition table="c71$000000" prime="m71$" inquiry="i71$" field="ngay_ct" expression="convert(char(6), {0}, 112)" increase="dateadd(month, 1, {0})" default="000000"/>
  <fields>
    <field name="stt_rec" isPrimaryKey="true" width="0" hidden="true">
      <header v="" e=""></header>
    </field>
    <field name="ma_dvcs" width="100" aliasName="a">
      <header v="Đơn vị" e="Unit"></header>
    </field>
    <field name="ngay_ct" type="DateTime" dataFormatString="@datetimeFormat" width="100">
      <header v="Ngày" e="Date"></header>
    </field>
    <field name="so_ct" width="80" align="right">
      <header v="Số chứng từ" e="Number"></header>
    </field>
	<field name="so_ct0" width="80" align="right">
      <header v="Số hóa đơn" e="Invoice Number"></header>
    </field>
    <field name="ma_kh" width="100" aliasName="a">
      <header v="Mã khách" e="Customer ID"></header>
    </field>
    <field name="ten_kh%l" width="200" external="true" aliasName="b">
      <header v="Tên khách" e="Customer Name"></header>
    </field>
	<field name="dien_giai" width="200" >
      <header v="Diễn giải" e="Description"></header>
    </field>
    <field name="t_tt_nt" type="Decimal" dataFormatString="@baseCurrencyAmountViewFormat" width="120" clientDefault="0">
      <header v="Tiền" e="Amount"></header>
      <items style="Numeric"/>
    </field>
    <field name="ma_nt" width="100">
      <header v="Mã nt" e="Currency Code"></header>
    </field>
	<field name="t_chi_nt" type="Decimal" dataFormatString="@baseCurrencyAmountViewFormat" width="100" hyperlinkFormatString="~/AppHandler/Voucher.ashx Query: {Name: '[ma_ct]', Value: '[stt_rec_chi]'}, Script: 'beforeDrillDown(this);'">
      <header v="Xem phiếu chi" e="VC Code"></header>
    </field>
	<field name="stt_rec_chi" width="0" hidden="true">
      <header v="" e=""></header>
    </field>
	<field name="ma_ct" width="0" hidden="true">
      <header v="" e=""></header>
    </field>		
    <field name="user_id0" width="70" aliasName = "a">
      <header v="User tạo" e="User"></header>
    </field>
	<field name="user_id2" width="70" aliasName = "a">
      <header v="User sửa" e="User"></header>
    </field>
  </fields>

  <views>
    <view id="Grid">
      <field name="stt_rec"/>
      <field name="ma_dvcs"/>
      <field name="ngay_ct"/>
      <field name="so_ct"/>
	  <field name="so_ct0"/>
      <field name="ma_kh"/>
      <field name="ten_kh%l"/>
	  <field name="dien_giai"/>
      <field name="t_tt_nt"/>
      <field name="ma_nt"/>
	  <field name="t_chi_nt"/>
      <field name="ma_ct"/>	  
      <field name="stt_rec_chi"/>
      <field name="user_id0"/>
      <field name="user_id2"/>
    </view>
  </views>

  <css>
    <text>
      <![CDATA[
div.ImportData{background-image:url(../images/Upload.png);background-repeat:no-repeat;background-position:0 0;}
div.ImportDataOverGreen{background-position:0 -22px;}
div.Download{background-image:url(../Images/Download.png);background-repeat:no-repeat;background-position:0 0;}
div.DownloadOverGreen{background-position:0 -22px;}
]]>
    </text>
  </css>
  <toolbar>
    <button command="New">
      <title v="Toolbar.New" e="Toolbar.New"></title>
    </button>
    <button command="Edit">
      <title v="Toolbar.Edit" e="Toolbar.Edit"></title>
    </button>
    <button command="Delete">
      <title v="Toolbar.Delete" e="Toolbar.Delete"></title>
    </button>

    <button command="Clone">
      <title v="Toolbar.Copy" e="Toolbar.Copy"></title>
    </button>
    <button command="Export">
      <title v="Toolbar.Export" e="Toolbar.Export"></title>
    </button>
    <!--<button command="Search">
      <title v="Toolbar.Search" e="Toolbar.Search"></title>
    </button>-->
    <button command="View">
      <title v="Toolbar.View" e="Toolbar.View"></title>
    </button>
    <button command="Print">
      <title v="Toolbar.Print" e="Toolbar.Print"></title>
    </button>

    <button command="-">
      <title v="-" e="-"/>
    </button>

    <button command="ImportData">
      <title v="Lấy dữ liệu từ tệp..." e="Import Data from File..."></title>
    </button>
    <button command="Download">
      <title v="Tải tệp mẫu..." e="Download Template File..."/>
    </button>

    <button command="Separate">
      <title v="-" e="-"/>
    </button>
    <button command="Freeze">
      <title v="Toolbar.Freeze" e="Toolbar.Freeze"></title>
    </button>
	<button command="Youtube">
      <title v="Youtube" e="Youtube"></title>
    </button>
  </toolbar>

  <commands>
    <command event="Loading">
      <text>
        &CreateTicket;
        &CommandWhenVoucherBeforeInit;
        <![CDATA[select @message = @message + 'this._authorize = ' + rtrim(@@sysDatabaseName.dbo.Sthink$System$GetAuthorize(@@admin, @@userID, 'PVTran', 'New')) + ';this._key = ''' + @ticket + ''';load$Grid(this);']]>
        &CommandWhenVoucherBeforeAddNew;
        &CommandWhenVoucherAfterInit;
      </text>
    </command>
  </commands>
  <script>
    <text>
      <![CDATA[
function load$Grid(g) {
  g.add_onResponseComplete(on$GridSalesInvoice$ResponseComplete);
  g.add_commandEvent(on$GridSalesInvoice$ExecuteCommand);
}
function dispose$Grid(g) {
  try {g.remove_commandEvent(on$GridSalesInvoice$ExecuteCommand);} catch (ex) {}
  try {g.remove_onResponseComplete(on$GridSalesInvoice$ResponseComplete);} catch (ex) {}  
}
function on$GridSalesInvoice$ExecuteCommand(sender, e) {
  var action = e.type.Action, g = sender;
  switch (action) {
    case 'ImportData':
      show$Form(g, 'PVMasterImport');
      break;
    case 'Download':
      request$Download(g, action);
      break;
	case 'Youtube':
	  window.open("https://www.youtube.com/watch?v=Ge1rsCD-ZbI&list=UUkoQfw7sdKP44V9uagHuvkA&index=7", "_newtab");  
	break;  
    default:
      break;
  }
}
function on$GridSalesInvoice$ResponseComplete(sender, e) {
  var g = e.object, context = e.type.Context, result = e.type.Result, o = e.type.Object;
  switch (context) {
    case 'Download':
      g._key = result[0].Value;
      break;
    default:
      break;
  }
}
function show$Form(g, c) { 
  (g._authorize == 1) && (!g._denyNew) ? g.showForm(c) : $message.show(g._denyMessage ? g._denyMessage : $df.getResources(g._language, "Message.NotAccess"));
}
]]>
      &DowloadScript;
	  
    </text>
  </script>
  <response>
    <action id="Download">
      <text>
        &CreateTicket;<![CDATA[
select @ticket as value
return
]]>
      </text>
    </action>
  </response>
  <queries>

    <query event="Finding">
      <text>
        <![CDATA[exec CRM$App$Voucher$Finding
@@id, @@master, @@prime, @@inquiry, @@partition, @@expression, @@increase, @@extension, @@refresh, @@pageIndex, @@pageCount, @@lastPage, @@lastCount, @@firstItem, @@lastItem, 
@@keyMaster, @@keyDetail, 'stt_rec', @@textList, @@textExternal, 
'a left join dmkh b on a.ma_kh = b.ma_kh', @@textOrderBy, @@admin, @@userID, 1, 
null, null, '', '', '*', N'0', @@unit]]>
      </text>
    </query>
  </queries>
</grid>